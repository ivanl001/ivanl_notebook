{
  "title": "04-Hive-0201-Hiveçš„ä½¿ç”¨02",
  "cells": [
    {
      "type": "markdown",
      "data": "---\næ³¨ï¼šunionåœ¨mysqlå’Œhiveä¸­ä½¿ç”¨æ–¹æ³•ä¸€æ ·\n* unionæŸ¥è¯¢çš„ä½¿ç”¨ï¼š\n* mysql> select id, orderno from orders union select id, name from customers;\n* è¿™ä¸ªçš„ä½œç”¨æ˜¯æŠŠä¸åŒè¡¨æŸ¥å‡ºæ¥çš„å†…å®¹ç«–ç›´çš„æ’åˆ—åœ¨ä¸€èµ·ï¼Œ è·Ÿjoinæ°´å¹³æ’åˆ—åœ¨ä¸€èµ·æ˜¯å¯¹åº”çš„ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„ï¼šunionå‰åçš„åˆ—æ•°éœ€è¦ä¸€ç›´ï¼Œè¦ä¸ç„¶æ²¡æ³•æ’åˆ—åœ¨ä¸€èµ·ã€‚\n---\n\nselect * from TBLS \\G;  ğŸ˜\\Gæ˜¯è¡Œè½¬åˆ—ï¼Œåœ¨æŸ¥çœ‹çš„æ—¶å€™æ¯”è¾ƒæ–¹ä¾¿ä¸€äº›ï¼ŒæŠ€èƒ½+1ï¼›"
    },
    {
      "type": "markdown",
      "data": "## 1ï¼ŒHiveçš„ä½¿ç”¨\n### 01ï¼Œè‡ªåŠ¨åˆ†åŒº(åŠ¨æ€åˆ†åŒº)ï¼š\n  *åœ¨åŠ å…¥çš„æ—¶å€™æ ¹æ®åŠ å…¥æ•°æ®çš„å­—æ®µè‡ªåŠ¨åˆ†åŒºï¼Œè€Œä¸å¿…æŠŠåˆ†åŒºæ•°æ®å®šæ­»ã€‚å¦‚ä¸‹ï¼Œæ¼”ç¤ºä¸€ä¸‹åŠ¨æ€åˆ†åŒº*\n\n  * é¦–å…ˆåˆ›å»ºä¸€ä¸ªæœ‰å¹´ä»½å’Œæœˆä»½çš„è¡¨ï¼Œç”¨ä½œæ•°æ®æ’å…¥çš„å…ƒæ•°æ®\n    > create table t7 (id int , name string , age int, year string, month string);\n  \n  * ç„¶åæ’å…¥ä¸¤æ¡ä¸åŒå¹´ä»½æˆ–æœˆä»½çš„æ•°æ®å§\n    > insert into t7 (id, name, age, year, month) values (1, \"ivanl0000\", 10, 2015, 12);\n  \n    > insert into t7 (id, name, age, year, month) values (2, \"ivanl111111\", 15, 2016, 11);\n  \n  * ç„¶åæŠŠä¸Šé¢è¡¨ä¸­çš„ä¸¤æ¡æ•°æ®æ’å…¥åˆ°æˆ‘ä»¬ä¹‹å‰å»ºçš„åˆ†åŒºè¡¨t5ä¸­å»ï¼Œå› ä¸ºå¹¶æ²¡æœ‰å¼€å¯åŠ¨æ€åˆ†åŒºï¼Œä¼šæŠ¥é”™ï¼š\n    > insert into t5 partition (year, month) select id, name, age, year, month from t7;\n  \n  * ä¸Šé¢çš„æ’å…¥ä¼šæŠ¥é”™ï¼š\n    > FAILED: SemanticException [Error 10096]: Dynamic partition strict mode requires at least one static partition column. To turn this off set hive.exec.dynamic.partition.mode=nonstrict\n  \n  * æ ¹æ®æç¤ºå¯ä»¥çŸ¥é“éœ€è¦è®¾ç½®åˆ†åŒºæ¨¡å¼ä¸ºéä¸¥æ ¼æ¨¡å¼\n    > set hive.exec.dynamic.partition.mode=nonstrict\n  \n  * é‡æ–°æ’å…¥å‘ç°okäº†\n  \n### 02ï¼Œhiveçš„äº‹åŠ¡\n\n*åªæœ‰ç”¨äº‹åŠ¡æ‰èƒ½æ”¯æŒè¡Œçº§æ“ä½œï¼Œæ¯”å¦‚æ›´æ–°ï¼Œåˆ é™¤æŸä¸€è¡Œç­‰ç­‰*\n \n \n  * ä½¿ç”¨äº‹åŠ¡å¿…é¡»è¦å…ˆé…ç½®å¦‚ä¸‹ï¼š\n    ```\n    1.æ‰€æœ‰äº‹åŠ¡è‡ªåŠ¨æäº¤ã€‚\n    2.åªæ”¯æŒorcæ ¼å¼ã€‚\n    3.ä½¿ç”¨bucketè¡¨ã€‚\n    4.é…ç½®hiveå‚æ•°ï¼Œä½¿å…¶æ”¯æŒäº‹åŠ¡ã€‚\n  \t\n    SET hive.support.concurrency = true;\t\t\t\t\n    SET hive.enforce.bucketing = true;\n    //ä¸Šé¢ä¼šæŠ¥é”™Query returned non-zero code: 1, cause: hive configuration hive.enforce.bucketing does not exists.ï¼Œå…ˆå¿½ç•¥\n    SET hive.exec.dynamic.partition.mode = nonstrict;\t\n    SET hive.txn.manager = org.apache.hadoop.hive.ql.lockmgr.DbTxnManager;\n    SET hive.compactor.initiator.on = true;\n    SET hive.compactor.worker.threads = 1;\n    ```\n  \n  * æ˜¾ç¤ºå½“å‰è¿è¡Œçš„äº‹åŠ¡\n    > show transactions;\n  \n  * æ›´æ–°æ“ä½œ(é»˜è®¤ä½¿ç”¨äº‹åŠ¡è‡ªåŠ¨æäº¤)\n    > update t2 set name = 'ivanl001' where id = 2;\n    * å…¶å®ä¼šæŠ¥é”™ï¼šFAILED: SemanticException [Error 10297]: Attempt to do update or delete on table imdb.t2 that does not use an AcidOutputFormat or is not bucketedï¼Œ å› ä¸ºè¡¨ä¸æ˜¯æ¡¶è¡¨\n    \n  * æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œéœ€è¦é‡æ–°å»ºç«‹ä¸€ä¸ªæ¡¶è¡¨,ä½†æ˜¯è·Ÿä¹‹å‰ä¸ä¸€æ ·ï¼Œè¿™é‡Œéœ€è¦é¢å¤–è®¾ç½®å­˜å‚¨æ ¼å¼ä¸ºorc\n    > create table t8 (id int, name string, age int) clustered by (id) into 3 buckets row format delimited fields terminated by ',' stored as orc;\n\n  * å› ä¸ºloadæ˜¯æ²¡åŠæ³•å®Œæˆåˆ†æ¡¶æ“ä½œçš„ï¼Œ æ‰€ä»¥è¿˜æ˜¯å’Œä¹‹å‰ä¸€æ ·ï¼Œ ç›´æ¥ä»t5è¡¨ä¸­æ‹·è´è¿‡æ¥\n    > insert into t8 select id, name, age from t5;\n\n  * æ‰§è¡Œæ›´æ–°æ“ä½œ\n    > update t8 set name = \"ivanl001\" where id = 3;\n    * ä¸è¿‡è¿˜æ˜¯ä¼šæŠ¥é”™ï¼š FAILED: SemanticException [Error 10122]: Bucketized tables do not support INSERT INTO: Table: imdb.t8\n    * æœ€åå‘ç°æ˜¯æœ‰ä¸€ä¸ªå±æ€§éœ€è¦åœ¨åˆ›å»ºè¡¨çš„æ—¶å€™æŒ‡å®šï¼Œæ‰€ä»¥æˆ‘ä»¬é‡æ–°åˆ›å»ºè¡¨t9, å…·ä½“å±æ€§å¦‚ä¸‹\n  \n  * é‡æ–°åˆ›å»ºæ–°è¡¨t9:éœ€è¦è®¾ç½®å±æ€§TBLPROPERTIES, æ³¨æ„ï¼šå•è¯åˆ«å†™é”™äº†ï¼Œåƒè¿‡äº\n    > create table t9 (id int, name string, age int) clustered by (id) into 3 buckets row format delimited fields terminated by ',' stored as orc tblproperties  ('transactional'='true');\n \n  * ç„¶åé‡æ–°æŠŠæ•°æ®æ‹·è´è¿‡æ¥\n    > insert into t9 select id, name, age from t5;\n\n  * æ‰§è¡Œæ›´æ–°æ“ä½œ\n    > update t8 set name = \"ivanl001\" where id = 3;\n\n  * è¿™æ¬¡å°±okå•¦ã€‚å˜¿å˜¿ğŸ˜\n    \n### 03ï¼Œgroup by\n*æ³¨æ„ï¼šåˆ†ç»„èšåˆçš„è¯ï¼Œselectçš„ä¿¡æ¯åªèƒ½æ˜¯ç»„çš„ä¿¡æ¯ï¼Œè€Œä¸èƒ½æ˜¯æ¯ä¸€æ¡çš„ä¿¡æ¯äº†ï¼Œ æ¯”å¦‚è¯´æŒ‰ç…§ç”¨æˆ·åˆ†ç»„ï¼Œé‚£ä¹ˆèƒ½æŸ¥å‡ºæ¥çš„è‚¯å®šæ˜¯è¿™ä¸ªç”¨æˆ·çš„æ¯”å¦‚è¯´è®¢å•æ•°é‡ï¼Œ è®¢å•æ€»é‡‘é¢ç­‰ç­‰ï¼Œè€Œä¸èƒ½æ˜¯å…·ä½“è®¢å•ç­‰ä¿¡æ¯*\n  * select id, name, price , cid from orders group by cid;\n    * æ‰€ä»¥è¿™ä¸ªä¼šç›´æ¥æŠ¥é”™ï¼šFAILED: SemanticException [Error 10025]: Line 1:7 Expression not in GROUP BY key 'id'\n    \n  * select count(*), sum(price), cid from orders group by cid;//è¿™æ ·æ˜¯å¯ä»¥çš„\n  \n  * select count(*), sum(price) as s, cid from orders group by cid having cid > 30;//åˆ†ç»„ä¹‹åå†è¿›è¡Œæ¡ä»¶ç­›é€‰"
    },
    {
      "type": "markdown",
      "data": "## 2, Hiveå‡½æ•°ï¼šwordcountçš„åº”ç”¨\n\n### 01ï¼Œhiveçš„wordcountç®—æ³•\n* é¦–å…ˆåˆ›å»ºè¡¨ï¼Œå­˜å‚¨éœ€è¦è®¡ç®—çš„æ•°æ®ï¼Œæ³¨æ„ï¼šè¿™é‡ŒæŒ‡å®šçš„æ˜¯å­—æ®µçš„åˆ†éš”ç¬¦\n  > create table word_count (line string) ROW FORMAT DELIMITED FIELDS TERMINATED BY ',' ;\n\n* åŠ è½½æ•°æ®\n  > load data local inpath '/root/share/word_count.txt' into table word_count;\n\n* ä½¿ç”¨å†…ç½®å‡½æ•°è¿›è¡Œè®¡ç®—\n  * é¦–å…ˆæŠŠæ¯ä¸€è¡Œåˆ‡æˆæ•°ç»„\n    > select split(line, ' ') from word_count;\n  * å†é€šè¿‡explodeå‡½æ•°æŠŠæ•°ç»„ç‚¸å¼€\n    > select  explode(split(line, ' ')) from word_count;\n  * ä¹‹åé€šè¿‡å­æŸ¥è¯¢æœ€ç»ˆç¡®å®šä¸ªæ•°, è¿™ä¸ªé€»è¾‘æœ‰ç‚¹ç»•ï¼Œå…¶å®ç®€å•æ¥è®²ï¼Œå°±æ˜¯æŠŠå•ä¸ªå•è¯çš„é›†åˆå½“ä½œt, æ¯ä¸ªå•è¯å°±æ˜¯tä¸­çš„wordï¼Œæˆ‘ä»¬é€šè¿‡å¯¹wordåˆ†ç»„ï¼Œç®—å‡ºè¿™ç»„çš„æ€»æ•°å°±æ˜¯äº†ï¼Œå¯¹å§\n    > select t.word, count(*) from ((select  explode(split(line, ' ')) as word from word_count) as t) group by t.word;\n  \n  * æœ€åè¿˜éœ€è¦æŠŠç»“æœè®°å½•ä¸‹æ¥ï¼Œåªæ˜¯æ‰“å°åœ¨æ§åˆ¶å°ä¸Šæ˜¯ä¸è¡Œçš„, è¿™é‡Œå°±æ˜¯ç›¸å½“äºç›´æ¥åˆ›å»ºä¸€ä¸ªè¡¨ï¼ŒæŠŠåˆšæ‰çš„ç»“æœå¤åˆ¶è¿›å»ï¼Œä¹Ÿå°±æ˜¯create ... as ...å°±å¯ä»¥äº†\n    > create table wc_result as select t.word, count(*) from ((select  explode(split(line, ' ')) as word from word_count) as t) group by t.word;"
    },
    {
      "type": "markdown",
      "data": "## 3ï¼ŒHiveçš„view\n*ç›¸å½“äºæ˜¯å¤æ‚æŸ¥è¯¢çš„å¿«æ·æ–¹å¼ï¼ŒæŠŠæŸ¥è¯¢è¯­å¥å­˜åˆ°viewä¸­å»*\n\n* 01ï¼Œæ¯”å¦‚è¯´ä½ ç»å¸¸ä½¿ç”¨åˆ°è¿æ¥æŸ¥è¯¢è¯­å¥\n  >  select a.\\*, b.\\* from customers as a left outer join orders as b on a.id = b.cid;\n\n* 02ï¼Œæ¯æ¬¡éƒ½å†™è¿™ä¹ˆå¤šå¾ˆéº»çƒ¦, æ‰€ä»¥å¯ä»¥æŠŠè¿™è¯­å¥å­˜å…¥åˆ°viewä¸­\n  > create view join01_view as select a.\\*, b.\\* from customers as a left outer join orders as b on a.id = b.cid;\n\n* 03, å› ä¸ºcustomers å’Œ ordersä¸­éƒ½æœ‰idå­—æ®µï¼Œä¼šé‡å¤ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦å…·ä½“æŒ‡å®š\n  > create view join01_view as select a.id as aid, a.name, b.id as bid, b.orderno, b.price from customers as a left outer join orders as b on a.id = b.cid;\n\n* 04ï¼Œæ˜¾ç¤ºshow tablesï¼Œå¯ä»¥çœ‹åˆ°å¤šäº†ä¸€ä¸ªè¡¨ï¼Œè¿™ä¸ªè¡¨æ˜¯è™šæ‹Ÿè¡¨ï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹å…¶ä¿¡æ¯å…·ä½“æŸ¥çœ‹\n  > show tables;\n  > desc formatted join01_view;\n\n* 05, é€šè¿‡æ“çºµè¿™å¼ è¡¨æ¥æŸ¥çœ‹åˆšæ‰æˆ‘ä»¬éœ€è¦æŸ¥çœ‹çš„ä¿¡æ¯,åªä¸è¿‡è¯­å¥å°±æ–¹ä¾¿å¤šäº†\n  > select * from join01_view;\n\n* 06, ä¹Ÿå¯ä»¥æŸ¥æŸäº›å­—æ®µ\n  > select aid, price from join01_view;"
    },
    {
      "type": "markdown",
      "data": "## 4ï¼ŒHiveçš„è°ƒä¼˜\n\n### Map join: Mapç«¯çš„è¿æ¥ï¼Œä¹Ÿå°±æ˜¯ä¸€å°è¡¨ï¼Œä¸€å¤§è¡¨çš„è¿æ¥\n* 01ï¼Œè®¾ç½®è‡ªåŠ¨è½¬æ¢ï¼Œé»˜è®¤å°±æ˜¯å¼€å¯çš„å“ˆ\n  > set hive.auto.convert.join=true\t\t\t//è®¾ç½®è‡ªåŠ¨è½¬æ¢è¿æ¥,é»˜è®¤å¼€å¯äº†ã€‚\n\n* 02, ç”¨è¿æ¥æš—ç¤ºå¯ä»¥è¿›è¡Œmapç«¯è¿æ¥ï¼Œä½†æ˜¯è¿™ä¸ªè¯­å¥åŸå…ˆä¹Ÿæ˜¯æ²¡æœ‰rçš„ï¼Œæ‰€ä»¥è¿™é‡Œè²Œä¼¼æ²¡æœ‰ä»€ä¹ˆå‚è€ƒæ„ä¹‰ã€‚\n  > select a.\\*,b.\\* from customers a left outer join orders b on a.id = b.cid ;//è¿™é‡Œä¹Ÿæ²¡æœ‰reducer\n\n  > select /*+ mapjoin(customers) */ a.*, b.* from customers a left outer join orders b on a.id = b.cid ;\n  \n### æŸ¥çœ‹è¯­å¥çš„æ‰§è¡Œæµç¨‹å’Œæ•´ä½“æƒ…å†µexplain\n\n* 01, åœ¨éœ€è¦æŸ¥çœ‹çš„è¯­å¥å‰æ·»åŠ explainå…³é”®å­—å°±å¯ä»¥\n  > explain select * from t8;\n  \n  > explain select a.\\*,b.\\* from customers a left outer join orders b on a.id = b.cid;\n\n* 02, æŸ¥çœ‹æ›´åŠ è¯¦å°½çš„æ­¥éª¤ä¿¡æ¯\n  \n  > explain extended select * from t8;\n\n\n### å¯¹äºå°æ•°æ®é‡æ•°æ®ï¼Œå¯ä»¥å¯ç”¨æœ¬åœ°æ¨¡å¼å•æœºè¿›è¡Œå¤„ç†\n\n* 01, é¦–å…ˆéœ€è¦è®¾ç½®é…ç½®\n  > set mapred.job.tracker=local;\n    * è¿™ä¸€è¡Œè®¾ç½®äº†å¥½åƒæ²¡å•¥ä½œç”¨ï¼Œä¸æ¸…æ¥š, è¿è¡Œmrä¾ç„¶å¥½åƒæ˜¯åˆ†å¸ƒå¼çš„ï¼Œç„¶åæ§åˆ¶å°åå°ä¹Ÿèƒ½æŸ¥åˆ°\n\n  > set hive.exec.mode.local.auto=true;\n    * è¿™åªè¿™ä¸€è¡Œå¥½åƒæ˜¯å¯¹çš„ï¼Œå› ä¸ºé€Ÿåº¦å¿«å¤šäº†ï¼Œè€Œä¸”åˆ†å¸ƒå¼çš„æ§åˆ¶å°åå°ä¹ŸæŸ¥ä¸åˆ°è¿™ä¸ªè¿›ç¨‹äº†ï¼Œè¯´æ˜æ˜¯åœ¨æœ¬åœ°æ‰§è¡Œçš„ï¼Œ å½“ç„¶è¿™ä¸ªæ¨¡å¼å°æ•°æ®æµ‹è¯•å¯ä»¥æé«˜é€Ÿåº¦ï¼Œç”Ÿäº§çš„è¯åº”ç”¨æ„ä¹‰ä¸å¤§\n    \n### å¹¶è¡Œæ‰§è¡Œ \n  *ç®€å•æ¥è®²ï¼Œå°±æ˜¯æŠŠå…¶ä¸­å¯ä»¥æ‹†å¼€çš„æ­¥éª¤æ‹†å¼€ï¼Œæ¯”å¦‚åˆ†ç»„ï¼Œèšåˆå•¥çš„ï¼Œç„¶åå¹¶è¡Œæ‰§è¡Œè¿™äº›æ­¥éª¤ï¼Œæé«˜é€Ÿåº¦*\n  \n  * 01, è®¾ç½®é…ç½®\n    > set hive.exec.parallel=true\n\n  * 02, æ‰§è¡Œéœ€è¦å¹¶è¡Œçš„ä»»åŠ¡å°±å¯ä»¥äº†ï¼Œè¿™é‡Œå¯ä»¥è‡ªåŠ¨è¯†åˆ«é‚£äº›æ˜¯å¯ä»¥å¹¶è¡Œçš„ï¼Œæ‰€ä»¥å¾ˆç®€å•\n  \n### ä¸¥æ ¼æ¨¡å¼\n*ä¸¥æ ¼æ¨¡å¼ç¦ç”¨äº†ä¸€äº›æŸ¥è¯¢ï¼Œæ¯”å¦‚è¯´ä¸æŒ‡å®šåˆ†åŒºè¿‡æ»¤å™¨æŸ¥è¯¢åˆ†åŒºï¼Œè¿™æ ·ä¼šå…¨ç›˜æ‰«æï¼Œæ•°æ®é‡æ¯”è¾ƒå¤§ç­‰ç­‰*\n\n* 01ï¼Œå¼€å¯ä¸¥æ ¼æ¨¡å¼:\n  > set hive.mapred.mode=strict\n\n* 02, åˆ†åŒºè¡¨å¿…é¡»æŒ‡å®šåˆ†åŒºè¿›è¡ŒæŸ¥è¯¢\n* 03, order byæ—¶å¿…é¡»ä½¿ç”¨limitå­å¥ã€‚\n* 04, ä¸å…è®¸ç¬›å¡å°”ç§¯.\n\n\n### è®¾ç½®MRçš„æ•°é‡\n\n* 01, è®¾ç½®é…ç½®\n  > set hive.exec.reducers.bytes.per.reducer=750000000;\n    * è®¾ç½®reducerå¤„ç†çš„å­—èŠ‚æ•°, è¿™é‡Œè®¾ç½®750M\n\n### JVMé‡ç”¨\n\n*å¤§æ¦‚çš„æ„æ€å°±æ˜¯å¦‚æœè®¾ç½®æˆ1ï¼Œå°±æ˜¯è™šæ‹Ÿæœºçš„æ§½ä½åœ¨å¤„ç†è¿‡å½“å‰çš„ä»»åŠ¡åå°±ä¼šå…³é—­ï¼Œä½†æ˜¯å¦‚æœè®¾ç½®æˆå…¶ä»–æ•°å€¼ï¼Œæˆ–è€…è®¾ç½®æˆ-1ï¼Œè™šæ‹Ÿæœºåœ¨å¤„ç†å½“å‰ä»»åŠ¡åä¸ä¼šå…³é—­ï¼Œä¼šç­‰å¾…æ¥å—å…¶ä»–ä»»åŠ¡ï¼Œé‡æ–°ä½¿ç”¨è¿›è¡Œå¤„ç†ï¼ŒçŸ¥é“jobç»“æŸ*\n\n* 01ï¼Œè®¾ç½®é…ç½®\n  > set mapreduce.job.jvm.numtasks=1\t\t//-1æ²¡æœ‰é™åˆ¶ï¼Œé€‚ç”¨å¤§é‡å°æ–‡ä»¶ã€‚\n\n\n\n\n\n"
    },
    {
      "type": "markdown",
      "data": "\n\n\n\n\n\n\n\n\n\n\n\n\n#ddd"
    }
  ]
}